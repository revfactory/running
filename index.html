<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Îã¨Î¶¨Í∏∞ ÎåÄÌöå</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { overflow: hidden; background: #87CEEB; font-family: 'Arial', sans-serif; }
canvas { display: block; }

#ui {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
  z-index: 10;
}

#scoreboard {
  position: absolute;
  top: 16px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 8px;
  opacity: 0;
  transition: opacity 0.5s;
}

.rank-card {
  background: rgba(0,0,0,0.7);
  border-radius: 10px;
  padding: 8px 14px;
  min-width: 80px;
  text-align: center;
  backdrop-filter: blur(10px);
  border: 2px solid rgba(255,255,255,0.1);
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.rank-card.first {
  transform: scale(1.12);
  border-color: #FFD700;
  box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
}

.rank-card.first::before {
  content: '';
  position: absolute;
  top: -50%; left: -50%;
  width: 200%; height: 200%;
  background: linear-gradient(45deg, transparent 40%, rgba(255,215,0,0.1) 50%, transparent 60%);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.rank-card .rank-num { font-size: 10px; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 1px; }
.rank-card .name { font-size: 16px; font-weight: bold; margin: 2px 0; }
.rank-card .speed-bar { height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 4px; overflow: hidden; }
.rank-card .speed-fill { height: 100%; border-radius: 2px; transition: width 0.3s; width: 50%; }

#commentary {
  position: absolute;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  color: #fff;
  font-size: 22px;
  font-weight: bold;
  text-align: center;
  opacity: 0;
  transition: opacity 0.3s;
  text-shadow: 0 0 10px rgba(0,0,0,0.8), 0 0 30px rgba(255,50,50,0.3);
  white-space: nowrap;
  pointer-events: none;
}

#commentary.active { opacity: 1; animation: commentPop 0.3s ease-out; }

@keyframes commentPop {
  0% { transform: translateX(-50%) scale(0.5); opacity: 0; }
  60% { transform: translateX(-50%) scale(1.1); }
  100% { transform: translateX(-50%) scale(1); opacity: 1; }
}

#overtake-flash {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
  z-index: 5;
  opacity: 0;
  transition: opacity 0.1s;
}

#start-screen {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 100;
}

#start-screen h1 { color: #fff; font-size: 56px; text-shadow: 0 0 40px rgba(255,100,100,0.5); margin-bottom: 8px; letter-spacing: 4px; }
#start-screen .subtitle { color: rgba(255,255,255,0.5); font-size: 14px; letter-spacing: 6px; text-transform: uppercase; margin-bottom: 32px; }
#start-screen .chars { display: flex; gap: 16px; margin-bottom: 40px; }

.char-preview {
  text-align: center;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  padding: 16px 20px;
  transition: transform 0.2s;
}
.char-preview:hover { transform: scale(1.05); border-color: rgba(255,255,255,0.3); }
.char-preview .dot { width: 36px; height: 36px; border-radius: 50%; margin: 0 auto 8px; box-shadow: 0 0 15px currentColor; }
.char-preview .cname { color: #fff; font-weight: bold; font-size: 18px; }
.char-preview .gender { color: rgba(255,255,255,0.4); font-size: 12px; }

.start-btn {
  background: linear-gradient(135deg, #e74c3c, #c0392b);
  border: none;
  padding: 18px 56px;
  font-size: 24px;
  font-weight: bold;
  border-radius: 50px;
  cursor: pointer;
  color: #fff;
  box-shadow: 0 6px 30px rgba(231,76,60,0.4);
  transition: transform 0.2s, box-shadow 0.2s;
  pointer-events: auto;
  letter-spacing: 4px;
  text-transform: uppercase;
}
.start-btn:hover { transform: scale(1.08); box-shadow: 0 8px 40px rgba(231,76,60,0.6); }

#countdown {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 99;
  pointer-events: none;
}

#countdown .num { font-size: 150px; font-weight: 900; color: #fff; text-shadow: 0 0 60px rgba(255,50,50,0.8); animation: countPulse 0.8s ease-out; }

@keyframes countPulse {
  0% { transform: scale(2); opacity: 0; }
  30% { opacity: 1; }
  100% { transform: scale(1); opacity: 0.8; }
}

#lap-counter {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  color: #fff;
  font-size: 14px;
  background: rgba(0,0,0,0.6);
  padding: 8px 20px;
  border-radius: 20px;
  backdrop-filter: blur(5px);
}

#tension-bar {
  position: absolute;
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
  width: 200px;
  text-align: center;
  opacity: 0;
  transition: opacity 0.5s;
}
#tension-bar .label { font-size: 10px; color: rgba(255,255,255,0.5); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 4px; }
#tension-bar .bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
#tension-bar .fill { height: 100%; border-radius: 2px; transition: width 0.5s, background 0.5s; background: #4ade80; }

#camera-hint {
  position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
  color: rgba(255,255,255,0.3); font-size: 11px; opacity: 1; transition: opacity 2s;
}

#vignette {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none; z-index: 4;
  background: radial-gradient(ellipse at center, transparent 50%, rgba(0,0,0,0.4) 100%);
}

/* ‚îÄ‚îÄ‚îÄ Result Screen ‚îÄ‚îÄ‚îÄ */
#result-screen {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.85);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 100;
  backdrop-filter: blur(8px);
}

#result-screen .result-title {
  font-size: 42px;
  font-weight: 900;
  color: #FFD700;
  text-shadow: 0 0 40px rgba(255,215,0,0.5);
  margin-bottom: 8px;
  letter-spacing: 6px;
  animation: resultTitleIn 0.8s ease-out;
}

@keyframes resultTitleIn {
  0% { transform: scale(0.3) rotate(-10deg); opacity: 0; }
  60% { transform: scale(1.1) rotate(2deg); }
  100% { transform: scale(1) rotate(0); opacity: 1; }
}

#result-screen .result-subtitle {
  color: rgba(255,255,255,0.5);
  font-size: 14px;
  letter-spacing: 3px;
  margin-bottom: 36px;
}

.result-row {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 14px 32px;
  margin: 6px 0;
  border-radius: 12px;
  min-width: 320px;
  animation: rowSlideIn 0.5s ease-out both;
}

.result-row:nth-child(1) { animation-delay: 0.3s; }
.result-row:nth-child(2) { animation-delay: 0.5s; }
.result-row:nth-child(3) { animation-delay: 0.7s; }
.result-row:nth-child(4) { animation-delay: 0.9s; }

@keyframes rowSlideIn {
  0% { transform: translateX(-60px); opacity: 0; }
  100% { transform: translateX(0); opacity: 1; }
}

.result-row.gold { background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.05)); border: 1px solid rgba(255,215,0,0.4); }
.result-row.silver { background: linear-gradient(135deg, rgba(192,192,192,0.15), rgba(192,192,192,0.03)); border: 1px solid rgba(192,192,192,0.3); }
.result-row.bronze { background: linear-gradient(135deg, rgba(205,127,50,0.15), rgba(205,127,50,0.03)); border: 1px solid rgba(205,127,50,0.3); }
.result-row.fourth { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); }

.result-rank { font-size: 28px; font-weight: 900; width: 45px; text-align: center; }
.result-rank.r1 { color: #FFD700; }
.result-rank.r2 { color: #C0C0C0; }
.result-rank.r3 { color: #CD7F32; }
.result-rank.r4 { color: rgba(255,255,255,0.4); }

.result-color { width: 24px; height: 24px; border-radius: 50%; box-shadow: 0 0 10px currentColor; }
.result-name { font-size: 22px; font-weight: bold; color: #fff; flex: 1; }
.result-medal { font-size: 28px; }

#result-screen .result-actions {
  margin-top: 36px;
  animation: rowSlideIn 0.5s ease-out both;
  animation-delay: 1.2s;
}

#result-screen .result-overtakes {
  color: rgba(255,255,255,0.4);
  font-size: 13px;
  margin-top: 16px;
  animation: rowSlideIn 0.5s ease-out both;
  animation-delay: 1.1s;
}
</style>
</head>
<body>

<div id="start-screen">
  <h1>RACE!</h1>
  <div class="subtitle">ÌÖîÎ†àÌÜ†ÎπÑ ÎèôÏÇ∞ Îã¨Î¶¨Í∏∞ ÎåÄÌöå</div>
  <div class="chars">
    <div class="char-preview"><div class="dot" style="background:#FF69B4;color:#FF69B4;"></div><div class="cname">ÎÇòÎÇò</div><div class="gender">‚ôÄ</div></div>
    <div class="char-preview"><div class="dot" style="background:#FFD700;color:#FFD700;"></div><div class="cname">Ï°∞ÏïÑ</div><div class="gender">‚ôÄ</div></div>
    <div class="char-preview"><div class="dot" style="background:#FF6347;color:#FF6347;"></div><div class="cname">ÎùºÎùº</div><div class="gender">‚ôÄ</div></div>
    <div class="char-preview"><div class="dot" style="background:#4FC3F7;color:#4FC3F7;"></div><div class="cname">Î°úÎ°ú</div><div class="gender">‚ôÇ</div></div>
  </div>
  <button class="start-btn" id="start-btn">START</button>
</div>

<div id="countdown"><div class="num"></div></div>
<div id="vignette"></div>
<div id="overtake-flash"></div>

<div id="ui">
  <div id="scoreboard">
    <div class="rank-card" id="rank-0"><div class="rank-num">1st</div><div class="name">-</div><div class="speed-bar"><div class="speed-fill"></div></div></div>
    <div class="rank-card" id="rank-1"><div class="rank-num">2nd</div><div class="name">-</div><div class="speed-bar"><div class="speed-fill"></div></div></div>
    <div class="rank-card" id="rank-2"><div class="rank-num">3rd</div><div class="name">-</div><div class="speed-bar"><div class="speed-fill"></div></div></div>
    <div class="rank-card" id="rank-3"><div class="rank-num">4th</div><div class="name">-</div><div class="speed-bar"><div class="speed-fill"></div></div></div>
  </div>
  <div id="tension-bar"><div class="label">Ï†ëÏ†ÑÎèÑ</div><div class="bar"><div class="fill"></div></div></div>
  <div id="commentary"></div>
  <div id="lap-counter"></div>
  <div id="camera-hint">ÎßàÏö∞Ïä§ ÎìúÎûòÍ∑∏: Ïπ¥Î©îÎùº ÌöåÏ†Ñ | Ïä§ÌÅ¨Î°§: Ï§å</div>
</div>

<div id="result-screen">
  <div class="result-title">FINISH!</div>
  <div class="result-subtitle">ÏµúÏ¢Ö ÏàúÏúÑ</div>
  <div id="result-rows"></div>
  <div class="result-overtakes" id="result-overtakes"></div>
  <div class="result-actions">
    <button class="start-btn" id="restart-btn">Îã§Ïãú Îã¨Î¶¨Í∏∞</button>
  </div>
</div>

<script type="importmap">
{ "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
import * as THREE from 'three';

const CHARACTERS = [
  { name: 'ÎÇòÎÇò', color: 0xFF69B4, skinColor: 0xFFDBC4, gender: 'F', hairColor: 0x2a1a0a },
  { name: 'Ï°∞ÏïÑ', color: 0xFFD700, skinColor: 0xF5D0A9, gender: 'F', hairColor: 0x5c3317 },
  { name: 'ÎùºÎùº', color: 0xFF6347, skinColor: 0xFFE0BD, gender: 'F', hairColor: 0x1a1a2e },
  { name: 'Î°úÎ°ú', color: 0x4FC3F7, skinColor: 0xE8C39E, gender: 'M', hairColor: 0x1a1a1a },
];

const TRACK_RADIUS = 40, TRACK_WIDTH = 10, LANE_COUNT = 4, LANE_WIDTH = TRACK_WIDTH / LANE_COUNT;

let running = false, finished = false, time = 0, runners = [];
let cameraAngle = 0, cameraPitch = 0.35, cameraDist = 18, targetCameraDist = 18;
let isDragging = false, lastMouse = { x: 0, y: 0 };
let prevRankOrder = [], commentTimer = null, screenShake = 0;
let cameraMode = 'chase', cameraModeTimer = 0, tensionLevel = 0;
let lastOvertakeTime = -10, overtakeCount = 0;
let raceStartTime = 0;

function setProps(obj,props){for(const[k,v]of Object.entries(props)){if(k==='position')obj.position.copy(v);else if(k==='rotation')obj.rotation.copy(v);else obj[k]=v;}return obj;}

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);
scene.fog = new THREE.FogExp2(0x87CEEB, 0.004);
const camera = new THREE.PerspectiveCamera(65, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
document.body.appendChild(renderer.domElement);

const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
scene.add(ambientLight);
const sunLight = new THREE.DirectionalLight(0xFFF8E1, 1.4);
sunLight.position.set(60, 80, 40);
sunLight.castShadow = true;
sunLight.shadow.mapSize.width = 2048; sunLight.shadow.mapSize.height = 2048;
sunLight.shadow.camera.left = -80; sunLight.shadow.camera.right = 80;
sunLight.shadow.camera.top = 80; sunLight.shadow.camera.bottom = -80;
scene.add(sunLight);
scene.add(new THREE.HemisphereLight(0x87CEEB, 0x56ab2f, 0.3));

const sun = new THREE.Mesh(new THREE.SphereGeometry(8, 16, 16), new THREE.MeshBasicMaterial({ color: 0xFFFF44 }));
sun.position.set(100, 120, -80); scene.add(sun);
const rayMat = new THREE.MeshBasicMaterial({ color: 0xFFFF88, transparent: true, opacity: 0.3 });
for (let i = 0; i < 8; i++) { const r = new THREE.Mesh(new THREE.BoxGeometry(1, 14, 1), rayMat); r.position.copy(sun.position); r.rotation.z = (i/8)*Math.PI; scene.add(r); }

// Ground
const groundGeo = new THREE.PlaneGeometry(300, 300, 80, 80); groundGeo.rotateX(-Math.PI/2);
const posAttr = groundGeo.attributes.position;
for (let i = 0; i < posAttr.count; i++) {
  const x = posAttr.getX(i), z = posAttr.getZ(i), d = Math.sqrt(x*x+z*z);
  posAttr.setY(i, d < TRACK_RADIUS+TRACK_WIDTH+3 ? 0 : Math.max(0, Math.sin(x*0.04)*4+Math.cos(z*0.05)*3+Math.sin(x*0.02+z*0.03)*6+Math.cos(x*0.06-z*0.04)*2));
}
groundGeo.computeVertexNormals();
const ground = new THREE.Mesh(groundGeo, new THREE.MeshStandardMaterial({ color: 0x7CCD3B, roughness: 0.9 }));
ground.receiveShadow = true; scene.add(ground);

// Track
const outerR = TRACK_RADIUS+TRACK_WIDTH/2, innerR = TRACK_RADIUS-TRACK_WIDTH/2;
const trackShape = new THREE.Shape();
for (let i=0;i<=64;i++){const a=(i/64)*Math.PI*2;if(i===0)trackShape.moveTo(Math.cos(a)*outerR,Math.sin(a)*outerR);else trackShape.lineTo(Math.cos(a)*outerR,Math.sin(a)*outerR);}
const holePath = new THREE.Path();
for (let i=0;i<=64;i++){const a=(i/64)*Math.PI*2;if(i===0)holePath.moveTo(Math.cos(a)*innerR,Math.sin(a)*innerR);else holePath.lineTo(Math.cos(a)*innerR,Math.sin(a)*innerR);}
trackShape.holes.push(holePath);
const trackGeo = new THREE.ShapeGeometry(trackShape); trackGeo.rotateX(-Math.PI/2);
const track = new THREE.Mesh(trackGeo, new THREE.MeshStandardMaterial({ color: 0xD2691E, roughness: 0.95 }));
track.position.y = 0.05; track.receiveShadow = true; scene.add(track);
for (let lane=0;lane<=LANE_COUNT;lane++){const r=innerR+lane*LANE_WIDTH;const pts=[];for(let i=0;i<=64;i++){const a=(i/64)*Math.PI*2;pts.push(new THREE.Vector3(Math.cos(a)*r,0.08,Math.sin(a)*r));}scene.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts),new THREE.LineBasicMaterial({color:0xffffff,transparent:true,opacity:lane===0||lane===LANE_COUNT?0.8:0.35})));}

// Finish line
const finishGeo = new THREE.PlaneGeometry(TRACK_WIDTH, 1);
const finishCanvas = document.createElement('canvas'); finishCanvas.width=64; finishCanvas.height=8;
const fctx = finishCanvas.getContext('2d');
for (let x=0;x<64;x++) for (let y=0;y<8;y++) { fctx.fillStyle = (x+y)%2===0?'#fff':'#000'; fctx.fillRect(x,y,1,1); }
const finishTex = new THREE.CanvasTexture(finishCanvas);
finishTex.wrapS = finishTex.wrapT = THREE.RepeatWrapping;
const finishMat = new THREE.MeshBasicMaterial({ map: finishTex, transparent: true, opacity: 0.9 });
const finishLine = new THREE.Mesh(finishGeo, finishMat);
finishLine.rotation.x = -Math.PI/2;
finishLine.position.set(TRACK_RADIUS, 0.1, 0);
scene.add(finishLine);

// Scenery
const flowerColors = [0xFF69B4,0xFF6347,0xFFD700,0xFF00FF,0xFF4500,0xDA70D6];
function createFlower(x,z,color){const g=new THREE.Group();const s=new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.05,0.6,4),new THREE.MeshStandardMaterial({color:0x2d8a2d}));s.position.y=0.3;g.add(s);for(let i=0;i<5;i++){const p=new THREE.Mesh(new THREE.SphereGeometry(0.15,6,6),new THREE.MeshStandardMaterial({color}));const a=(i/5)*Math.PI*2;p.position.set(Math.cos(a)*0.15,0.65,Math.sin(a)*0.15);p.scale.y=0.6;g.add(p);}const c=new THREE.Mesh(new THREE.SphereGeometry(0.1,6,6),new THREE.MeshStandardMaterial({color:0xFFFF00}));c.position.y=0.65;g.add(c);g.position.set(x,0,z);g.scale.setScalar(0.8+Math.random()*0.6);return g;}
for(let i=0;i<200;i++){const a=Math.random()*Math.PI*2,d=outerR+3+Math.random()*80;scene.add(createFlower(Math.cos(a)*d,Math.sin(a)*d,flowerColors[Math.floor(Math.random()*flowerColors.length)]));}
for(let i=0;i<60;i++){const a=Math.random()*Math.PI*2,d=Math.random()*(innerR-4);scene.add(createFlower(Math.cos(a)*d,Math.sin(a)*d,flowerColors[Math.floor(Math.random()*flowerColors.length)]));}

const bunnies=[];
for(let i=0;i<10;i++){const a=Math.random()*Math.PI*2,d=innerR*Math.random()*0.7;const g=new THREE.Group();const m=new THREE.MeshStandardMaterial({color:0xeeeeee,roughness:0.8});const body=new THREE.Mesh(new THREE.SphereGeometry(0.4,8,8),m);body.position.y=0.4;body.scale.set(1,0.8,0.8);g.add(body);const head=new THREE.Mesh(new THREE.SphereGeometry(0.25,8,8),m);head.position.set(0,0.75,0.15);g.add(head);for(let s=-1;s<=1;s+=2){g.add(setProps(new THREE.Mesh(new THREE.CapsuleGeometry(0.06,0.3,4,4),m),{position:new THREE.Vector3(s*0.12,1.1,0.15),rotation:new THREE.Euler(0,0,s*0.2)}));g.add(setProps(new THREE.Mesh(new THREE.SphereGeometry(0.04,6,6),new THREE.MeshBasicMaterial({color:0x111111})),{position:new THREE.Vector3(s*0.1,0.8,0.35)}));}g.add(setProps(new THREE.Mesh(new THREE.SphereGeometry(0.12,6,6),m),{position:new THREE.Vector3(0,0.4,-0.35)}));g.position.set(Math.cos(a)*d,0,Math.sin(a)*d);g.userData={baseX:Math.cos(a)*d,baseZ:Math.sin(a)*d,hopPhase:Math.random()*Math.PI*2};scene.add(g);bunnies.push(g);}

for(let i=0;i<25;i++){const a=Math.random()*Math.PI*2,d=outerR+10+Math.random()*70,s=1.5+Math.random()*2;const g=new THREE.Group();const t=new THREE.Mesh(new THREE.CylinderGeometry(s*0.15,s*0.2,s*1.5,6),new THREE.MeshStandardMaterial({color:0x8B4513}));t.position.y=s*0.75;t.castShadow=true;g.add(t);const l=new THREE.Mesh(new THREE.SphereGeometry(s*0.8,8,8),new THREE.MeshStandardMaterial({color:0x2ECC40,roughness:0.8}));l.position.y=s*1.8;l.castShadow=true;g.add(l);g.position.set(Math.cos(a)*d,0,Math.sin(a)*d);scene.add(g);}

const butterflies=[];
for(let i=0;i<15;i++){const g=new THREE.Group();const col=[0xFF69B4,0xFFD700,0x87CEEB,0xFF6347,0xDA70D6][Math.floor(Math.random()*5)];const wm=new THREE.MeshBasicMaterial({color:col,side:THREE.DoubleSide,transparent:true,opacity:0.8});for(let s=-1;s<=1;s+=2){const w=new THREE.Mesh(new THREE.CircleGeometry(0.3,6),wm);w.position.x=s*0.15;w.rotation.y=s*0.5;w.userData.side=s;g.add(w);}g.add(new THREE.Mesh(new THREE.CapsuleGeometry(0.03,0.2,3,3),new THREE.MeshBasicMaterial({color:0x333333})));const a=Math.random()*Math.PI*2,d=Math.random()*80;g.position.set(Math.cos(a)*d,2+Math.random()*4,Math.sin(a)*d);g.userData={phase:Math.random()*Math.PI*2,centerX:g.position.x,centerZ:g.position.z,radius:2+Math.random()*5};scene.add(g);butterflies.push(g);}

[0xFF0000,0xFF7F00,0xFFFF00,0x00FF00,0x0000FF,0x4B0082,0x9400D3].forEach((color,i)=>{const r=60+i*1.5;const curve=new THREE.EllipseCurve(0,0,r,r,0,Math.PI,false,0);scene.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(curve.getPoints(50).map(p=>new THREE.Vector3(p.x,p.y,-100))),new THREE.LineBasicMaterial({color,transparent:true,opacity:0.3})));});

// Dust
const dustCount=300,dustGeo=new THREE.BufferGeometry(),dustPos=new Float32Array(dustCount*3),dustVel=new Float32Array(dustCount*3),dustLife=new Float32Array(dustCount);
for(let i=0;i<dustCount;i++){dustPos[i*3]=dustPos[i*3+1]=dustPos[i*3+2]=0;dustLife[i]=0;}
dustGeo.setAttribute('position',new THREE.Float32BufferAttribute(dustPos,3));
const dustMat=new THREE.PointsMaterial({color:0xD2B48C,size:0.3,transparent:true,opacity:0.6,sizeAttenuation:true,depthWrite:false});
scene.add(new THREE.Points(dustGeo,dustMat));
let dustIndex=0;
function emitDust(x,y,z){for(let j=0;j<3;j++){const i=dustIndex%dustCount;dustPos[i*3]=x+(Math.random()-0.5)*0.5;dustPos[i*3+1]=y+Math.random()*0.3;dustPos[i*3+2]=z+(Math.random()-0.5)*0.5;dustVel[i*3]=(Math.random()-0.5)*2;dustVel[i*3+1]=1+Math.random()*2;dustVel[i*3+2]=(Math.random()-0.5)*2;dustLife[i]=1;dustIndex++;}}
function updateDust(delta){for(let i=0;i<dustCount;i++){if(dustLife[i]<=0)continue;dustLife[i]-=delta*1.5;dustPos[i*3]+=dustVel[i*3]*delta;dustPos[i*3+1]+=dustVel[i*3+1]*delta;dustPos[i*3+2]+=dustVel[i*3+2]*delta;dustVel[i*3+1]-=3*delta;if(dustLife[i]<=0)dustPos[i*3+1]=-100;}dustGeo.attributes.position.needsUpdate=true;}

// Speed lines
const speedLineMeshes=[];
for(let i=0;i<30;i++){const m=new THREE.Mesh(new THREE.CylinderGeometry(0.015,0.015,3+Math.random()*5,4),new THREE.MeshBasicMaterial({color:0xffffff,transparent:true,opacity:0}));m.userData.offset=Math.random()*Math.PI*2;scene.add(m);speedLineMeshes.push(m);}

// Burst
const burstParticles=[];
function createBurst(x,y,z,color){for(let i=0;i<20;i++){const m=new THREE.Mesh(new THREE.SphereGeometry(0.08,4,4),new THREE.MeshBasicMaterial({color,transparent:true,opacity:1}));m.position.set(x,y+1,z);const angle=Math.random()*Math.PI*2,speed=2+Math.random()*4;m.userData={vx:Math.cos(angle)*speed,vy:2+Math.random()*4,vz:Math.sin(angle)*speed,life:1};scene.add(m);burstParticles.push(m);}}
function updateBursts(delta){for(let i=burstParticles.length-1;i>=0;i--){const p=burstParticles[i];p.userData.life-=delta*2;p.position.x+=p.userData.vx*delta;p.position.y+=p.userData.vy*delta;p.position.z+=p.userData.vz*delta;p.userData.vy-=8*delta;p.material.opacity=Math.max(0,p.userData.life);p.scale.setScalar(p.userData.life);if(p.userData.life<=0){scene.remove(p);burstParticles.splice(i,1);}}}

// Character
function createCharacter(data,laneIndex){
  const group=new THREE.Group();
  const skinMat=new THREE.MeshStandardMaterial({color:data.skinColor,roughness:0.7});
  const clothMat=new THREE.MeshStandardMaterial({color:data.color,roughness:0.6});
  const hairMat=new THREE.MeshStandardMaterial({color:data.hairColor,roughness:0.8});
  const shoeMat=new THREE.MeshStandardMaterial({color:0x333333,roughness:0.5});

  const torso=new THREE.Mesh(new THREE.CapsuleGeometry(0.35,0.6,6,8),clothMat);torso.position.y=1.3;torso.castShadow=true;group.add(torso);
  const head=new THREE.Mesh(new THREE.SphereGeometry(0.3,10,10),skinMat);head.position.y=2.0;head.castShadow=true;group.add(head);

  if(data.gender==='F'){const hair=new THREE.Mesh(new THREE.SphereGeometry(0.32,10,10,0,Math.PI*2,0,Math.PI*0.6),hairMat);hair.position.y=2.05;group.add(hair);const pt=new THREE.Mesh(new THREE.CapsuleGeometry(0.08,0.3,4,4),hairMat);pt.position.set(0,2.0,-0.25);pt.rotation.x=0.5;group.add(pt);group.userData.ponytail=pt;}
  else{const hair=new THREE.Mesh(new THREE.SphereGeometry(0.31,10,10,0,Math.PI*2,0,Math.PI*0.45),hairMat);hair.position.y=2.05;group.add(hair);}

  for(let side=-1;side<=1;side+=2){group.add(setProps(new THREE.Mesh(new THREE.SphereGeometry(0.06,6,6),new THREE.MeshBasicMaterial({color:0xffffff})),{position:new THREE.Vector3(side*0.12,2.04,0.24)}));group.add(setProps(new THREE.Mesh(new THREE.SphereGeometry(0.035,6,6),new THREE.MeshBasicMaterial({color:0x111111})),{position:new THREE.Vector3(side*0.12,2.04,0.28)}));group.add(setProps(new THREE.Mesh(new THREE.CircleGeometry(0.05,8),new THREE.MeshBasicMaterial({color:0xFFAAAA,transparent:true,opacity:0.4})),{position:new THREE.Vector3(side*0.2,1.95,0.27)}));
    const brow=new THREE.Mesh(new THREE.BoxGeometry(0.08,0.02,0.01),new THREE.MeshBasicMaterial({color:data.hairColor}));brow.position.set(side*0.12,2.12,0.28);brow.rotation.z=side*-0.2;group.add(brow);}

  const lap=new THREE.Group();lap.position.set(-0.4,1.55,0);lap.add(setProps(new THREE.Mesh(new THREE.CapsuleGeometry(0.1,0.45,4,6),skinMat),{position:new THREE.Vector3(0,-0.28,0),castShadow:true}));group.add(lap);
  const rap=new THREE.Group();rap.position.set(0.4,1.55,0);rap.add(setProps(new THREE.Mesh(new THREE.CapsuleGeometry(0.1,0.45,4,6),skinMat),{position:new THREE.Vector3(0,-0.28,0),castShadow:true}));group.add(rap);
  const llp=new THREE.Group();llp.position.set(-0.15,0.95,0);llp.add(setProps(new THREE.Mesh(new THREE.CapsuleGeometry(0.12,0.45,4,6),clothMat),{position:new THREE.Vector3(0,-0.3,0),castShadow:true}));llp.add(setProps(new THREE.Mesh(new THREE.BoxGeometry(0.16,0.1,0.25),shoeMat),{position:new THREE.Vector3(0,-0.58,0.05)}));group.add(llp);
  const rlp=new THREE.Group();rlp.position.set(0.15,0.95,0);rlp.add(setProps(new THREE.Mesh(new THREE.CapsuleGeometry(0.12,0.45,4,6),clothMat),{position:new THREE.Vector3(0,-0.3,0),castShadow:true}));rlp.add(setProps(new THREE.Mesh(new THREE.BoxGeometry(0.16,0.1,0.25),shoeMat),{position:new THREE.Vector3(0,-0.58,0.05)}));group.add(rlp);

  const nc=document.createElement('canvas');nc.width=128;nc.height=48;const nctx=nc.getContext('2d');nctx.fillStyle='rgba(0,0,0,0.6)';nctx.beginPath();nctx.roundRect(4,4,120,40,12);nctx.fill();nctx.strokeStyle='#'+data.color.toString(16).padStart(6,'0');nctx.lineWidth=2;nctx.beginPath();nctx.roundRect(4,4,120,40,12);nctx.stroke();nctx.fillStyle='#fff';nctx.font='bold 24px Arial';nctx.textAlign='center';nctx.fillText(data.name,64,32);
  const ns=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(nc),transparent:true}));ns.position.y=2.6;ns.scale.set(1.2,0.45,1);group.add(ns);

  const auraMat=new THREE.MeshBasicMaterial({color:data.color,transparent:true,opacity:0,side:THREE.DoubleSide});
  const aura=new THREE.Mesh(new THREE.RingGeometry(0.5,0.8,16),auraMat);aura.rotation.x=-Math.PI/2;aura.position.y=0.1;group.add(aura);

  scene.add(group);
  const laneR=innerR+(laneIndex+0.5)*LANE_WIDTH;

  return {
    group,data,leftArmPivot:lap,rightArmPivot:rap,leftLegPivot:llp,rightLegPivot:rlp,torso,head,aura,auraMat,
    angle:0,laneRadius:laneR,speed:0,targetSpeed:0,
    baseSpeed:2.2+Math.random()*0.04,
    phase:Math.random()*Math.PI*2,
    laps:0,totalAngle:0,animPhase:Math.random()*Math.PI*2,rank:laneIndex,surging:false,finished:false,
    // Multiple waves for chaotic speed variation ‚Üí lots of overtakes
    waves:[
      {freq:0.25+Math.random()*0.3,amp:0.18+Math.random()*0.1,off:Math.random()*Math.PI*2},
      {freq:0.5+Math.random()*0.5,amp:0.1+Math.random()*0.06,off:Math.random()*Math.PI*2},
      {freq:0.8+Math.random()*0.6,amp:0.06+Math.random()*0.04,off:Math.random()*Math.PI*2},
      {freq:0.1+Math.random()*0.1,amp:0.2+Math.random()*0.12,off:Math.random()*Math.PI*2},
      {freq:1.5+Math.random()*1.0,amp:0.03+Math.random()*0.03,off:Math.random()*Math.PI*2},
    ],
  };
}

for(let i=0;i<CHARACTERS.length;i++) runners.push(createCharacter(CHARACTERS[i],i));
prevRankOrder=runners.map(r=>r.data.name);

// Commentary
const commentaryEl=document.getElementById('commentary');
const overtakeFlash=document.getElementById('overtake-flash');
function showCommentary(text,duration=2500){commentaryEl.textContent=text;commentaryEl.classList.add('active');clearTimeout(commentTimer);commentTimer=setTimeout(()=>commentaryEl.classList.remove('active'),duration);}
function flashScreen(color){overtakeFlash.style.background=`radial-gradient(ellipse at center,${color}33 0%,transparent 70%)`;overtakeFlash.style.opacity='1';setTimeout(()=>{overtakeFlash.style.opacity='0';},200);}

const OVERTAKE_COMMENTS=[
  (a,b)=>`${a}(Ïù¥)Í∞Ä ${b}ÏùÑ(Î•º) Ï∂îÏõî!!`,(a,b)=>`${a} ÎßπÏ∂îÍ≤©! ${b} Î∞ÄÎ¶∞Îã§!`,
  (a,b)=>`ÎåÄÏó≠Ï†Ñ!! ${a} ÏïûÏúºÎ°ú ÏπòÍ≥† ÎÇòÍ∞ÑÎã§!`,(a,b)=>`${a} ÎÜÄÎùºÏö¥ Ïä§ÌçºÌä∏!!`,
  (a,b)=>`${b} ÏúÑÍ∏∞! ${a} ÌååÏ£ΩÏßÄÏÑ∏!`,(a,b)=>`${a} Î¨¥ÏÑ≠Í≤å ÏπòÍ≥† Ïò¨ÎùºÏò®Îã§!`,
  (a,b)=>`${a} Ìè≠Ìíç ÏßàÏ£º! ${b} Îí§Î°ú Î∞ÄÎ†§!`,(a,b)=>`Ïó≠Ï†ÑÏóê Ïó≠Ï†Ñ! ${a}!!`,
];
const LEADER_COMMENTS=[(a)=>`${a} ÏÑ†Îëê ÏßàÏ£º Ï§ë!`,(a)=>`${a}, Î©àÏ∂ú Ï§Ñ Î™®Î•∏Îã§!`,(a)=>`ÌòÑÏû¨ ${a} 1ÏúÑ!`];
const CLOSE_RACE_COMMENTS=['Ï†ëÏ†Ñ! Ï†ëÏ†Ñ! Ï†ëÏ†Ñ!','ÎàÑÍ∞Ä Ïù¥Í∏∏ÏßÄ Î™®Î•∏Îã§!!','Ïà® ÎßâÌûàÎäî Ï†ëÏ†Ñ!!','Ìïú Ïπò ÏïûÏùÑ Î™ª Î≥∏Îã§!','Ìîº ÎßêÎ¶¨Îäî Î†àÏù¥Ïä§!','Ïó≠Ï†ÑÏóê Ïó≠Ï†ÑÏùÑ Í±∞Îì≠ÌïúÎã§!','ÏÜåÎ¶Ñ ÎèãÎäî Ï†ÑÍ∞ú!!'];
const FINAL_COMMENTS=['ÎßàÏßÄÎßâ ÏßÅÏÑ†!! ÎàÑÍ∞Ä Î®ºÏ†Ä Îì§Ïñ¥Ïò§ÎÇò!','Í≤∞ÏäπÏÑ†Ïù¥ ÏΩî ÏïûÏù¥Îã§!!','Ïä§ÌçºÌä∏! Ïä§ÌçºÌä∏! Ïä§ÌçºÌä∏!','ÎùºÏä§Ìä∏ Ïä§ÌçºÌä∏!!'];

// Camera
renderer.domElement.addEventListener('mousedown',(e)=>{isDragging=true;lastMouse.x=e.clientX;lastMouse.y=e.clientY;});
renderer.domElement.addEventListener('mousemove',(e)=>{if(!isDragging)return;cameraAngle-=(e.clientX-lastMouse.x)*0.005;cameraPitch=Math.max(0.08,Math.min(1.2,cameraPitch+(e.clientY-lastMouse.y)*0.005));lastMouse.x=e.clientX;lastMouse.y=e.clientY;});
renderer.domElement.addEventListener('mouseup',()=>{isDragging=false;});
renderer.domElement.addEventListener('mouseleave',()=>{isDragging=false;});
renderer.domElement.addEventListener('wheel',(e)=>{targetCameraDist=Math.max(8,Math.min(60,targetCameraDist+e.deltaY*0.03));});
renderer.domElement.addEventListener('touchstart',(e)=>{if(e.touches.length===1){isDragging=true;lastMouse.x=e.touches[0].clientX;lastMouse.y=e.touches[0].clientY;}});
renderer.domElement.addEventListener('touchmove',(e)=>{if(!isDragging||e.touches.length!==1)return;cameraAngle-=(e.touches[0].clientX-lastMouse.x)*0.005;cameraPitch=Math.max(0.08,Math.min(1.2,cameraPitch+(e.touches[0].clientY-lastMouse.y)*0.005));lastMouse.x=e.touches[0].clientX;lastMouse.y=e.touches[0].clientY;e.preventDefault();},{passive:false});
renderer.domElement.addEventListener('touchend',()=>{isDragging=false;});

// Start & Restart
function startCountdown(){
  const countdownEl=document.getElementById('countdown');
  countdownEl.style.display='flex';
  let count=3;
  const numEl=countdownEl.querySelector('.num');
  numEl.style.color='#fff';
  function tick(){
    if(count>0){numEl.textContent=count;numEl.style.animation='none';void numEl.offsetWidth;numEl.style.animation='countPulse 0.8s ease-out';count--;setTimeout(tick,1000);}
    else{numEl.textContent='GO!';numEl.style.color='#FFD700';numEl.style.animation='none';void numEl.offsetWidth;numEl.style.animation='countPulse 0.8s ease-out';setTimeout(()=>{countdownEl.style.display='none';document.getElementById('scoreboard').style.opacity='1';document.getElementById('tension-bar').style.opacity='1';running=true;finished=false;raceStartTime=time;showCommentary('Î†àÏù¥Ïä§ ÏãúÏûë!! üèÅ',2000);},600);}
  }
  tick();
}

function resetRace(){
  running=false;finished=false;overtakeCount=0;lastOvertakeTime=-10;prevRankOrder=[];
  runners.forEach((r,i)=>{r.angle=0;r.totalAngle=0;r.speed=0;r.targetSpeed=0;r.laps=0;r.surging=false;r.finished=false;r.animPhase=Math.random()*Math.PI*2;r.phase=Math.random()*Math.PI*2;
    r.baseSpeed=2.2+Math.random()*0.04;
    r.waves.forEach(w=>{w.freq=w===r.waves[0]?0.25+Math.random()*0.3:w===r.waves[3]?0.1+Math.random()*0.1:w.freq;w.amp*=(0.8+Math.random()*0.4);w.off=Math.random()*Math.PI*2;});
  });
  prevRankOrder=runners.map(r=>r.data.name);
}

document.getElementById('start-btn').addEventListener('click',()=>{
  document.getElementById('start-screen').style.display='none';
  startCountdown();
  setTimeout(()=>{document.getElementById('camera-hint').style.opacity='0';},6000);
});

document.getElementById('restart-btn').addEventListener('click',()=>{
  document.getElementById('result-screen').style.display='none';
  resetRace();
  startCountdown();
});

// Result screen
function showResult(){
  const sorted=[...runners].sort((a,b)=>b.totalAngle-a.totalAngle);
  const medals=['ü•á','ü•à','ü•â',''];
  const classes=['gold','silver','bronze','fourth'];
  const rankClasses=['r1','r2','r3','r4'];
  const rowsEl=document.getElementById('result-rows');
  rowsEl.innerHTML='';
  sorted.forEach((r,i)=>{
    const colorHex='#'+r.data.color.toString(16).padStart(6,'0');
    rowsEl.innerHTML+=`<div class="result-row ${classes[i]}"><div class="result-rank ${rankClasses[i]}">${i+1}</div><div class="result-color" style="background:${colorHex};color:${colorHex};"></div><div class="result-name">${r.data.name}</div><div class="result-medal">${medals[i]}</div></div>`;
  });
  document.getElementById('result-overtakes').textContent=`Ï¥ù Ï∂îÏõî ÌöüÏàò: ${overtakeCount}Ìöå | Í≤ΩÍ∏∞ ÏãúÍ∞Ñ: ${Math.floor(time-raceStartTime)}Ï¥à`;
  document.getElementById('result-screen').style.display='flex';
}

window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight);});

// UI
const rankLabels=['1st','2nd','3rd','4th'];
const tensionFill=document.querySelector('#tension-bar .fill');
let lastCommentTime=0;

function updateUI(){
  const sorted=[...runners].sort((a,b)=>b.totalAngle-a.totalAngle);
  const newOrder=sorted.map(r=>r.data.name);

  if(prevRankOrder.length&&time>raceStartTime+1&&!finished){
    for(let i=0;i<newOrder.length;i++){
      const prev=prevRankOrder.indexOf(newOrder[i]);
      if(prev>i&&time-lastOvertakeTime>1.5){
        const overtaker=newOrder[i],overtaken=prevRankOrder[i];
        overtakeCount++;
        const comment=OVERTAKE_COMMENTS[Math.floor(Math.random()*OVERTAKE_COMMENTS.length)];
        showCommentary(comment(overtaker,overtaken),2500);
        screenShake=0.7;lastOvertakeTime=time;lastCommentTime=time;
        const runner=runners.find(r=>r.data.name===overtaker);
        if(runner){flashScreen('#'+runner.data.color.toString(16).padStart(6,'0'));createBurst(runner.group.position.x,runner.group.position.y,runner.group.position.z,runner.data.color);}
        if(!isDragging){targetCameraDist=10;setTimeout(()=>{targetCameraDist=18;},1500);}
        break;
      }
    }
  }
  prevRankOrder=newOrder;

  sorted.forEach((runner,idx)=>{
    runner.rank=idx;
    const card=document.getElementById(`rank-${idx}`);
    card.querySelector('.name').textContent=runner.data.name;
    const colorHex='#'+runner.data.color.toString(16).padStart(6,'0');
    card.querySelector('.name').style.color=colorHex;
    card.querySelector('.rank-num').textContent=rankLabels[idx];
    const sf=card.querySelector('.speed-fill');sf.style.width=Math.min(100,(runner.speed/3)*100)+'%';sf.style.background=colorHex;
    card.classList.toggle('first',idx===0);
    card.style.borderColor=idx===0?'#FFD700':'rgba(255,255,255,0.1)';
  });

  const spread=sorted[0].totalAngle-sorted[sorted.length-1].totalAngle;
  tensionLevel=Math.max(0,Math.min(1,1-spread*4));
  tensionFill.style.width=(tensionLevel*100)+'%';
  tensionFill.style.background=tensionLevel>0.8?'#ef4444':tensionLevel>0.5?'#f59e0b':'#4ade80';

  if(time-lastCommentTime>4&&!finished){
    // Near finish line commentary
    const leaderProgress=sorted[0].totalAngle/(Math.PI*2);
    if(leaderProgress>0.85&&leaderProgress<0.98){
      showCommentary(FINAL_COMMENTS[Math.floor(Math.random()*FINAL_COMMENTS.length)],2000);
      lastCommentTime=time;
    } else if(tensionLevel>0.6){
      showCommentary(CLOSE_RACE_COMMENTS[Math.floor(Math.random()*CLOSE_RACE_COMMENTS.length)],2000);
      lastCommentTime=time;
    } else if(Math.random()<0.015){
      showCommentary(LEADER_COMMENTS[Math.floor(Math.random()*LEADER_COMMENTS.length)](sorted[0].data.name),2000);
      lastCommentTime=time;
    }
  }

  const leader=sorted[0];
  const progress=Math.min(100,((leader.totalAngle%(Math.PI*2))/(Math.PI*2))*100).toFixed(0);
  document.getElementById('lap-counter').textContent=`${leader.data.name} ÏÑ†Îëê | ÏßÑÌñâ: ${progress}%`;
}

// Main Loop
const clock=new THREE.Clock();
let finishDelay=0;

function animate(){
  requestAnimationFrame(animate);
  const delta=Math.min(clock.getDelta(),0.05);
  time+=delta;
  cameraDist+=(targetCameraDist-cameraDist)*delta*3;

  if(!running){
    runners.forEach((r,i)=>{const a=(i/runners.length)*0.1-0.05;r.group.position.set(Math.cos(a)*r.laneRadius,0,Math.sin(a)*r.laneRadius);r.group.rotation.y=-a;r.torso.scale.y=1+Math.sin(time*2+i)*0.02;});
    if(!isDragging)cameraAngle=time*0.15;
    camera.position.set(Math.cos(cameraAngle)*30,12,Math.sin(cameraAngle)*30);
    camera.lookAt(0,1.5,0);
    renderer.render(scene,camera);return;
  }

  // Check finish
  if(!finished){
    const anyFinished=runners.some(r=>r.totalAngle>=Math.PI*2);
    if(anyFinished){
      finished=true;finishDelay=0;
      showCommentary('Í≤∞ÏäπÏÑ† ÌÜµÍ≥º!! üèÅüèÅüèÅ',3000);
      screenShake=1;
    }
  }

  if(finished){
    finishDelay+=delta;
    // Slow down after finish
    runners.forEach(r=>{r.speed*=(1-delta*1.5);});
    if(finishDelay>3){
      running=false;
      document.getElementById('scoreboard').style.opacity='0';
      document.getElementById('tension-bar').style.opacity='0';
      showResult();
      renderer.render(scene,camera);return;
    }
  }

  // Camera modes
  cameraModeTimer+=delta;
  if(cameraModeTimer>6&&!isDragging){
    cameraModeTimer=0;
    const modes=['chase','chase','chase','side','dramatic'];
    cameraMode=modes[Math.floor(Math.random()*modes.length)];
    if(tensionLevel>0.6)cameraMode='dramatic';
  }

  // Update runners
  runners.forEach((runner)=>{
    if(finished){
      const p=runner.animPhase;
      runner.animPhase+=delta*runner.speed*4;
      runner.leftArmPivot.rotation.x=Math.sin(p)*0.5*runner.speed;
      runner.rightArmPivot.rotation.x=-Math.sin(p)*0.5*runner.speed;
      runner.leftLegPivot.rotation.x=-Math.sin(p)*0.4*runner.speed;
      runner.rightLegPivot.rotation.x=Math.sin(p)*0.4*runner.speed;
      const angularSpeed=runner.speed/runner.laneRadius;
      runner.angle+=angularSpeed*delta;runner.totalAngle+=angularSpeed*delta;
      runner.group.position.set(Math.cos(runner.angle)*runner.laneRadius,0,Math.sin(runner.angle)*runner.laneRadius);
      runner.group.rotation.y=-runner.angle;
      return;
    }

    // Speed from multiple overlapping waves ‚Üí chaotic, lots of position changes
    let waveSum=0;
    runner.waves.forEach(w=>{waveSum+=Math.sin(time*w.freq+w.off)*w.amp;});

    // Surge bursts - shorter, more frequent
    const surgeWave=Math.sin(time*0.35+runner.phase);
    const surge=surgeWave>0.7?0.25*(surgeWave-0.7)/0.3:0;
    runner.surging=surge>0.03;

    // Extra drama near finish
    const progress=runner.totalAngle/(Math.PI*2);
    const finishBoost=progress>0.8?Math.sin(time*2+runner.phase*3)*0.15:0;

    runner.targetSpeed=runner.baseSpeed+waveSum+surge+finishBoost;

    // Weaker rubber-banding ‚Üí allows more spread, more overtakes
    const avgAngle=runners.reduce((s,r)=>s+r.totalAngle,0)/runners.length;
    const diff=runner.totalAngle-avgAngle;
    runner.targetSpeed-=diff*0.12;

    // Drafting
    runners.forEach(other=>{if(other===runner)return;const ad=other.totalAngle-runner.totalAngle;if(ad>0&&ad<0.08)runner.targetSpeed+=0.04;});

    runner.speed+=(runner.targetSpeed-runner.speed)*delta*5;
    const angularSpeed=runner.speed/runner.laneRadius;
    runner.angle+=angularSpeed*delta;runner.totalAngle+=angularSpeed*delta;
    runner.laps=Math.floor(runner.totalAngle/(Math.PI*2));

    const x=Math.cos(runner.angle)*runner.laneRadius,z=Math.sin(runner.angle)*runner.laneRadius;
    runner.group.position.set(x,0,z);runner.group.rotation.y=-runner.angle;

    // Animation
    const animSpeed=runner.speed*4;runner.animPhase+=delta*animSpeed;const p=runner.animPhase;
    runner.leftArmPivot.rotation.x=Math.sin(p)*1.1;runner.rightArmPivot.rotation.x=-Math.sin(p)*1.1;
    runner.leftLegPivot.rotation.x=-Math.sin(p)*0.9;runner.rightLegPivot.rotation.x=Math.sin(p)*0.9;
    runner.torso.rotation.x=0.2+(runner.surging?0.1:0);
    runner.torso.position.y=1.3+Math.abs(Math.sin(p*2))*0.12;
    runner.head.position.y=2.0+Math.abs(Math.sin(p*2))*0.1;
    runner.group.position.y=Math.abs(Math.sin(p))*0.15;
    if(runner.group.userData.ponytail)runner.group.userData.ponytail.rotation.x=0.5+Math.sin(p*2)*0.3;
    runner.auraMat.opacity=runner.surging?0.3+Math.sin(time*10)*0.15:Math.max(0,runner.auraMat.opacity-delta*3);
    runner.aura.rotation.z=time*3;runner.aura.scale.setScalar(1+Math.sin(time*5)*0.2);
    if(runner.speed>1.5&&Math.random()<0.3)emitDust(x,0.05,z);
    if(runner.surging){emitDust(x,0.05,z);emitDust(x,0.05,z);}
  });

  updateDust(delta);updateBursts(delta);screenShake*=(1-delta*5);

  const leader=[...runners].sort((a,b)=>b.totalAngle-a.totalAngle)[0];
  const showLines=tensionLevel>0.4||leader.surging;
  speedLineMeshes.forEach((line,i)=>{if(showLines){line.visible=true;const offset=(time*15+i*2.5+line.userData.offset)%30-15;line.position.set(leader.group.position.x+Math.sin(i*1.3)*4,leader.group.position.y+1.5+Math.cos(i*0.7)*1.5,leader.group.position.z+Math.cos(i*1.7)*4);line.position.y+=offset*0.1;line.rotation.x=Math.PI/2;line.rotation.z=-leader.angle;line.material.opacity=Math.max(0,0.15-Math.abs(offset)*0.01)*(tensionLevel>0.7?2:1);}else{line.visible=false;}});

  bunnies.forEach(b=>{b.userData.hopPhase+=delta*2;b.position.y=Math.abs(Math.sin(b.userData.hopPhase))*0.3;b.position.x=b.userData.baseX+Math.sin(time*0.5+b.userData.hopPhase)*0.5;b.position.z=b.userData.baseZ+Math.cos(time*0.3+b.userData.hopPhase)*0.5;b.rotation.y=Math.sin(time*0.2+b.userData.hopPhase*0.5)*Math.PI;});
  butterflies.forEach(b=>{b.userData.phase+=delta*2;const p=b.userData.phase;b.position.x=b.userData.centerX+Math.sin(p*0.5)*b.userData.radius;b.position.z=b.userData.centerZ+Math.cos(p*0.7)*b.userData.radius;b.position.y=2+Math.sin(p)*1.5;b.children.forEach(c=>{if(c.userData.side)c.rotation.y=c.userData.side*(0.3+Math.sin(p*8)*0.7);});});

  const avgX=runners.reduce((s,r)=>s+r.group.position.x,0)/runners.length;
  const avgZ=runners.reduce((s,r)=>s+r.group.position.z,0)/runners.length;
  if(!isDragging){
    if(cameraMode==='chase'){const ta=leader.angle+Math.PI*0.55;cameraAngle+=(ta-cameraAngle)*delta*1.5;cameraPitch+=(0.25-cameraPitch)*delta*2;}
    else if(cameraMode==='side'){const ta=leader.angle+Math.PI/2;cameraAngle+=(ta-cameraAngle)*delta*2;cameraPitch+=(0.15-cameraPitch)*delta*2;targetCameraDist=12;}
    else if(cameraMode==='dramatic'){const ta=leader.angle+Math.PI*0.3;cameraAngle+=(ta-cameraAngle)*delta*2;cameraPitch+=(0.12-cameraPitch)*delta*2;targetCameraDist=10;}
  }
  const targetFOV=65+tensionLevel*15;camera.fov+=(targetFOV-camera.fov)*delta*2;camera.updateProjectionMatrix();
  const cx=avgX+Math.cos(cameraAngle)*cameraDist,cz=avgZ+Math.sin(cameraAngle)*cameraDist,cy=1.5+cameraDist*cameraPitch;
  const sx=screenShake*(Math.random()-0.5)*0.5,sy=screenShake*(Math.random()-0.5)*0.3;
  camera.position.lerp(new THREE.Vector3(cx+sx,cy+sy,cz+sx),delta*5);
  camera.lookAt(new THREE.Vector3(avgX,1.2,avgZ));
  if(tensionLevel>0.7)ambientLight.intensity=0.5+Math.sin(time*4)*0.05;else ambientLight.intensity=0.5;

  if(!finished)updateUI();
  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
